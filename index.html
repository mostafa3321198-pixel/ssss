<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <script type="module" src="firebase-config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الحسابات - تسجيل العملاء</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --accent-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --danger-color: #e63946;
            --warning-color: #fca311;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }
        
        h1 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .header-subtitle {
            color: var(--accent-color);
            font-size: 1.1rem;
        }
        
        .connection-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .search-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-container input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: white;
        }
        
        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .search-result-item:hover {
            background: #f8f9fa;
        }
        
        .client-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--secondary-color);
        }
        
        .client-id-badge {
            background: var(--accent-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .no-results {
            padding: 20px;
            text-align: center;
            color: #666;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .form-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--success-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }
        
        .auto-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .services-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .service-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
        }
        
        .service-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .service-item.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .service-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .service-price {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .service-item.selected .service-price {
            color: white;
        }
        
        .price-summary {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .price-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .price-box {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .price-box.pending {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: var(--dark-color);
        }
        
        .price-box.paid {
            background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
            color: var(--dark-color);
        }
        
        .payment-label {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .payment-amount {
            font-size: 1.3rem;
        }
        
        .payment-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .payment-status.paid {
            background: var(--success-color);
            color: white;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #4895ef);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #f3722c);
            color: white;
        }
        
        .btn-full {
            width: 100%;
            margin-top: 10px;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .payment-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .payment-history {
            margin-top: 20px;
            padding: 15px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
        }
        
        .payment-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .sync-status.syncing {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            color: white;
        }

        /* أنماط جديدة */
        .password-toggle {
            position: relative;
        }
        
        .password-toggle input {
            padding-right: 45px;
        }
        
        .toggle-password {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 16px;
        }

        .admin-login {
            text-align: center;
            margin-top: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .admin-section {
            display: none;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 25px;
        }

        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-controls input {
            flex: 1;
            min-width: 200px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .admin-table th, .admin-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        .admin-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
        }

        .admin-table tr:last-child td {
            border-bottom: none;
        }

        .admin-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-edit {
            background: var(--warning-color);
            color: white;
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .section-icon {
            background: var(--accent-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .services-section {
            margin: 20px 0;
        }

        .services-title {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reset-payments-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .reset-payments-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .payment-history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .payment-history-item:last-child {
            border-bottom: none;
        }

        /* مؤشر الحفظ التلقائي */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .auto-save-indicator.visible {
            opacity: 1;
        }
        
        .auto-save-indicator.saving {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            color: white;
        }
        
        .auto-save-indicator.saved {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }

        /* نماذج الفواتير الجديدة */
        .invoice-section {
            display: none;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 25px;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .invoice-services {
            margin-bottom: 20px;
        }

        .invoice-service-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .invoice-totals {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .invoice-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .invoice-total-row:last-child {
            margin-bottom: 0;
            font-weight: bold;
            font-size: 1.3rem;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 10px;
        }

        .invoice-payment-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .payment-status-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .payment-status-box.paid {
            border-color: var(--success-color);
            background: rgba(76, 201, 240, 0.1);
        }

        .payment-status-box.pending {
            border-color: var(--warning-color);
            background: rgba(252, 163, 17, 0.1);
        }

        .payment-status-amount {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .payment-status-label {
            font-size: 1rem;
            color: #666;
        }

        .payment-status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 5px;
        }

        .badge-paid {
            background: var(--success-color);
            color: white;
        }

        .badge-pending {
            background: var(--warning-color);
            color: white;
        }

        .invoice-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .invoice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .invoice-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .close-invoice-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--danger-color);
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }

        /* أنماط جديدة للإصلاح */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .form-error {
            border-color: #e63946 !important;
            box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2) !important;
        }

        .error-message {
            color: #e63946;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        /* إضافة جديدة: أداة تحديث رقم الفاتورة */
        .invoice-counter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(248, 249, 250, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .invoice-counter-controls h4 {
            width: 100%;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* إصلاح ألوان مربعات الدفعات */
        .price-box.paid {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf) !important;
            color: white !important;
        }

        .price-box.pending {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4) !important;
            color: var(--dark-color) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-wifi"></i> متصل
            </div>
            <h1><i class="fas fa-calculator"></i> نظام الحسابات - تسجيل العملاء</h1>
            <p class="header-subtitle">نظام متكامل لإدارة حسابات العملاء ومتابعة المدفوعات</p>
        </header>
        
        <section class="search-section">
            <h2><div class="section-icon"><i class="fas fa-search"></i></div> البحث عن العميل</h2>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="ابحث بالاسم، رقم التليفون، أو رقم العميل...">
                <button class="btn btn-primary" id="searchButton">
                    <i class="fas fa-search"></i> بحث
                </button>
                <button class="btn btn-warning" id="showInvoiceButton">
                    <i class="fas fa-file-invoice"></i> طلب فاتورة
                </button>
            </div>
            <div class="search-results" id="searchResults">
                <div class="no-results">أدخل كلمة البحث للعثور على العملاء</div>
            </div>
        </section>
        
        <div class="main-content">
            <section class="form-section">
                <h2><div class="section-icon"><i class="fas fa-user"></i></div> بيانات العميل</h2>
                <form id="clientForm">
                    <div class="form-group">
                        <label for="clientName"><i class="fas fa-signature"></i> اسم العميل</label>
                        <input type="text" id="clientName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone"><i class="fas fa-phone"></i> رقم التليفون</label>
                        <input type="tel" id="phone" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientEmail"><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                        <input type="email" id="clientEmail" required>
                    </div>

                    <!-- مربع كلمة سر جوجل -->
                    <div class="form-group password-toggle">
                        <label for="clientEmailPassword"><i class="fas fa-key"></i> كلمة سر إيميل العميل</label>
                        <input type="password" id="clientEmailPassword" placeholder="كلمة سر إيميل جوجل الخاص بالعميل" required>
                        <button type="button" class="toggle-password" id="toggleClientPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <div class="auto-info">
                        <div class="form-group">
                            <label for="clientId"><i class="fas fa-id-card"></i> رقم العميل</label>
                            <input type="text" id="clientId" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="registrationDate"><i class="fas fa-calendar-alt"></i> تاريخ التسجيل</label>
                            <input type="text" id="registrationDate" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="companyName"><i class="fas fa-building"></i> اسم الشركة</label>
                        <input type="text" id="companyName">
                    </div>
                    
                    <div class="form-group">
                        <label for="serviceCategory"><i class="fas fa-list-alt"></i> الفئة المطلوبة</label>
                        <select id="serviceCategory" required>
                            <option value="">اختر الفئة</option>
                            <option value="ads">إعلانات ممولة</option>
                            <option value="website">تصميم موقع</option>
                            <option value="system">نظام حساب</option>
                            <option value="video">إنتاج فيديو</option>
                            <option value="logo">تصميم لوجو أو شعار</option>
                            <option value="app">تصميم تطبيق موبايل</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="details"><i class="fas fa-edit"></i> المطلوب بالتفصيل</label>
                        <textarea id="details" required></textarea>
                    </div>
                </form>
            </section>
            
            <section class="form-section">
                <h2><div class="section-icon"><i class="fas fa-concierge-bell"></i></div> الخدمات المطلوبة</h2>
                
                <!-- قسم الخدمات -->
                <div class="services-section">
                    <h3 class="services-title"><i class="fas fa-cubes"></i> اختر الخدمات المطلوبة</h3>
                    <div class="services-container" id="servicesContainer">
                        <!-- الخدمات تُضاف هنا -->
                    </div>
                </div>
                
                <div class="price-summary">
                    <div class="price-row">
                        <span>المبلغ الإجمالي للخدمات:</span>
                        <span id="servicesTotal">0 درهم</span>
                    </div>
                    <div class="price-row">
                        <span>السعر المطلوب من العميل:</span>
                        <span id="requestedPriceDisplay">0 درهم</span>
                    </div>
                    <div class="price-row">
                        <span>المبلغ المتبقي:</span>
                        <span id="remainingAmount">0 درهم</span>
                    </div>
                </div>
                
                <div class="price-breakdown">
                    <div class="price-box pending" id="firstPayment">
                        <div class="payment-status pending">قيد الانتظار</div>
                        <div class="payment-label">الدفعة الأولى</div>
                        <div class="payment-amount" id="firstPaymentAmount">0 درهم</div>
                    </div>
                    <div class="price-box pending" id="secondPayment">
                        <div class="payment-status pending">قيد الانتظار</div>
                        <div class="payment-label">الدفعة الثانية</div>
                        <div class="payment-amount" id="secondPaymentAmount">0 درهم</div>
                    </div>
                </div>
                
                <div class="payment-controls">
                    <button class="btn btn-primary" id="confirmFirstPayment">
                        <i class="fas fa-check-circle"></i> تأكيد الدفعة الأولى
                    </button>
                    <button class="btn btn-primary" id="confirmSecondPayment">
                        <i class="fas fa-check-circle"></i> تأكيد الدفعة الثانية
                    </button>
                </div>
                
                <div class="payment-history">
                    <div class="payment-history-header">
                        <h3><i class="fas fa-history"></i> سجل المدفوعات</h3>
                        <button class="reset-payments-btn" id="resetPaymentsBtn">
                            <i class="fas fa-eraser"></i> تصفير السجل
                        </button>
                    </div>
                    <div id="paymentHistory">
                        <p style="text-align: center; color: #666;">لا توجد مدفوعات مسجلة بعد</p>
                    </div>
                </div>
                
                <button class="btn btn-success btn-full" id="submitOrder">
                    <i class="fas fa-paper-plane"></i> تأكيد الطلب
                </button>
            </section>
        </div>

        <!-- قسم الفاتورة -->
        <section class="invoice-section" id="invoiceSection">
            <div class="invoice-header">
                <h2><i class="fas fa-file-invoice"></i> فاتورة العميل</h2>
                <button class="btn btn-primary" id="printInvoice">
                    <i class="fas fa-print"></i> طباعة الفاتورة
                </button>
            </div>
            
            <div class="invoice-details">
                <div>
                    <h4>معلومات العميل</h4>
                    <p id="invoiceClientName">-</p>
                    <p id="invoiceClientId">-</p>
                    <p id="invoiceClientPhone">-</p>
                    <p id="invoiceClientEmail">-</p>
                </div>
                <div>
                    <h4>معلومات الفاتورة</h4>
                    <p id="invoiceDate">-</p>
                    <p id="invoiceNumber">-</p>
                    <p id="invoiceStatus">-</p>
                </div>
            </div>
            
            <div class="invoice-services">
                <h4>الخدمات المطلوبة</h4>
                <div id="invoiceServicesList">
                    <!-- سيتم ملؤها بالخدمات -->
                </div>
            </div>
            
            <div class="invoice-totals">
                <div class="invoice-total-row">
                    <span>المبلغ الإجمالي:</span>
                    <span id="invoiceTotalAmount">0 درهم</span>
                </div>
                <div class="invoice-total-row">
                    <span>المبلغ المدفوع:</span>
                    <span id="invoicePaidAmount">0 درهم</span>
                </div>
                <div class="invoice-total-row">
                    <span>المبلغ المتبقي:</span>
                    <span id="invoiceRemainingAmount">0 درهم</span>
                </div>
            </div>
            
            <div class="invoice-payment-status">
                <div class="payment-status-box" id="invoiceFirstPayment">
                    <div class="payment-status-label">الدفعة الأولى</div>
                    <div class="payment-status-amount" id="invoiceFirstPaymentAmount">0 درهم</div>
                    <div class="payment-status-badge badge-pending" id="invoiceFirstPaymentStatus">قيد الانتظار</div>
                </div>
                <div class="payment-status-box" id="invoiceSecondPayment">
                    <div class="payment-status-label">الدفعة الثانية</div>
                    <div class="payment-status-amount" id="invoiceSecondPaymentAmount">0 درهم</div>
                    <div class="payment-status-badge badge-pending" id="invoiceSecondPaymentStatus">قيد الانتظار</div>
                </div>
            </div>
            
            <div class="invoice-actions">
                <button class="btn btn-success" id="invoiceConfirmFirstPayment">
                    <i class="fas fa-check-circle"></i> تأكيد الدفعة الأولى
                </button>
                <button class="btn btn-success" id="invoiceConfirmSecondPayment">
                    <i class="fas fa-check-circle"></i> تأكيد الدفعة الثانية
                </button>
                <button class="btn btn-warning" id="closeInvoiceSection">
                    <i class="fas fa-times"></i> إغلاق الفاتورة
                </button>
            </div>
        </section>

        <!-- دخول الإدارة -->
        <div class="admin-login">
            <input type="password" id="adminPassword" placeholder="كلمة المرور للإدارة">
            <button class="btn btn-primary" id="adminLogin">
                <i class="fas fa-lock"></i> دخول الإدارة
            </button>
        </div>

        <!-- لوحة تحكم الإدارة -->
        <section class="admin-section" id="adminSection">
            <h2><div class="section-icon"><i class="fas fa-cogs"></i></div> لوحة تحكم الإدارة</h2>
            
            <!-- إضافة جديدة: أداة تحديث رقم الفاتورة -->
            <div class="invoice-counter-controls">
                <h4><i class="fas fa-file-invoice"></i> تحديث رقم الفاتورة</h4>
                <input type="number" id="newInvoiceCounter" placeholder="الرقم الجديد للفاتورة">
                <button class="btn btn-primary" id="updateInvoiceCounter">
                    <i class="fas fa-sync"></i> تحديث رقم الفاتورة
                </button>
                <div style="width: 100%; margin-top: 10px;">
                    <p style="font-size: 0.9rem; color: #666;">الرقم الحالي: <span id="currentInvoiceCounter">1001</span></p>
                </div>
            </div>
            
            <div class="admin-controls">
                <input type="text" id="newServiceName" placeholder="اسم الخدمة الجديدة">
                <input type="number" id="newServicePrice" placeholder="سعر الخدمة">
                <button class="btn btn-primary" id="addService">
                    <i class="fas fa-plus"></i> إضافة خدمة
                </button>
            </div>
            
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>اسم الخدمة</th>
                        <th>السعر (درهم)</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="servicesTable">
                    <!-- سيتم ملء هذا القسم بالخدمات -->
                </tbody>
            </table>
        </section>

        <!-- أزرار التنقل -->
        <div class="nav-buttons">
            <button class="btn btn-warning" id="goToClientsPage">
                <i class="fas fa-users"></i> صفحة العملاء
            </button>
            <button class="btn btn-warning" id="goToInvoicesPage">
                <i class="fas fa-file-invoice"></i> صفحة الفواتير
            </button>
            <button class="btn btn-success" id="goToInventoryPage">
                <i class="fas fa-warehouse"></i> صفحة الجرد
            </button>
            <button class="btn btn-primary" id="goToDashboardPage">
                <i class="fas fa-tachometer-alt"></i> لوحة التحكم
            </button>
        </div>
    </div>

    <!-- مؤشر الحفظ التلقائي -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <i class="fas fa-save"></i>
        <span id="saveMessage">جارٍ الحفظ...</span>
    </div>

    <!-- مؤشر المزامنة -->
    <div class="sync-status" id="syncStatus">
        <i class="fas fa-sync-alt"></i>
        <span>جاري المزامنة...</span>
    </div>

    <script>
        // البيانات
        let services = [
            { id: 1, name: "إعلانات ممولة", price: 2000 },
            { id: 2, name: "تصميم موقع", price: 5000 },
            { id: 3, name: "نظام حساب", price: 3000 },
            { id: 4, name: "إنتاج فيديو", price: 4000 },
            { id: 5, name: "تصميم لوجو", price: 1500 },
            { id: 6, name: "تصميم تطبيق", price: 8000 }
        ];

        let selectedServices = [];
        let totalAmount = 0;
        let clientCounter = 1001;
        let paymentHistory = [];
        let savedClients = [];
        let paidAmount = 0;
        let autoSaveTimeout;
        let currentClientId = null;

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
            setupAutoSave();
            loadFirebaseData();
        });

        // تحميل البيانات من Firebase
        async function loadFirebaseData() {
            try {
                // تحميل الإعدادات
                const settings = await firebaseApp.getSettings();
                if (settings.success && settings.data) {
                    if (settings.data.clientCounter) {
                        clientCounter = settings.data.clientCounter;
                        saveClientCounter();
                        generateClientId();
                    }
                }
                
                // تحميل الخدمات
                const servicesResult = await firebaseApp.getAllServices();
                if (servicesResult.success && servicesResult.data) {
                    services = Object.values(servicesResult.data);
                    saveServicesToStorage();
                    renderServices();
                    updateAdminTable();
                }
                
                // تحميل العملاء
                const clientsResult = await firebaseApp.getAllClients();
                if (clientsResult.success && clientsResult.data) {
                    savedClients = Object.values(clientsResult.data);
                    localStorage.setItem('savedClients', JSON.stringify(savedClients));
                }
                
                console.log("✅ تم تحميل البيانات من Firebase");
            } catch (error) {
                console.error("❌ خطأ في تحميل البيانات:", error);
                // استخدام البيانات المحلية
                loadServicesFromStorage();
            }
        }

        function initializePage() {
            loadClientCounter();
            generateClientId();
            setRegistrationDate();
            renderServices();
            loadSavedClients();
            updateAdminTable();
            updateInvoiceCounterDisplay();
        }

        function setupAutoSave() {
            // مراقبة تغييرات التخزين المحلي
            window.addEventListener('storage', function(e) {
                if (e.key === 'savedClients' || e.key === 'servicesData') {
                    triggerAutoSave();
                }
            });
            
            // تحديث دوري كل 30 ثانية
            setInterval(triggerAutoSave, 30000);
        }

        function triggerAutoSave() {
            clearTimeout(autoSaveTimeout);
            
            showAutoSaveIndicator('جارٍ حفظ التغييرات...', 'saving');
            
            autoSaveTimeout = setTimeout(() => {
                // إعادة تحميل البيانات
                loadSavedClients();
                loadServicesFromStorage();
                updateAdminTable();
                showAutoSaveIndicator('تم حفظ التغييرات تلقائياً', 'saved');
            }, 1000);
        }

        function showAutoSaveIndicator(message, type) {
            const indicator = document.getElementById('autoSaveIndicator');
            const messageElement = document.getElementById('saveMessage');
            
            messageElement.textContent = message;
            indicator.className = 'auto-save-indicator visible ' + type;
            
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 3000);
        }

        function loadServicesFromStorage() {
            const storedServices = localStorage.getItem('servicesData');
            if (storedServices) {
                services = JSON.parse(storedServices);
                renderServices();
                updateAdminTable();
            }
        }

        function saveServicesToStorage() {
            localStorage.setItem('servicesData', JSON.stringify(services));
        }

        function loadClientCounter() {
            const stored = localStorage.getItem('clientCounter');
            if (stored) clientCounter = parseInt(stored);
        }

        async function saveClientCounter() {
            try {
                localStorage.setItem('clientCounter', clientCounter.toString());
                console.log("تم حفظ العداد محلياً:", clientCounter);
                
                // محاولة المزامنة مع Firebase إذا كان متصلاً
                if (firebaseApp.isOnline()) {
                    const result = await firebaseApp.updateCounter(clientCounter);
                    if (result.success) {
                        console.log("✅ تم مزامنة العداد مع Firebase");
                    } else {
                        console.log("⚠️ تم حفظ العداد محلياً فقط (لا يوجد اتصال)");
                    }
                }
            } catch (error) {
                console.error("❌ خطأ في حفظ العداد:", error);
            }
        }

        function generateClientId() {
            document.getElementById('clientId').value = `CL${clientCounter}`;
        }

        function setRegistrationDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('registrationDate').value = now.toLocaleDateString('ar-EG', options);
        }

        function renderServices() {
            const container = document.getElementById('servicesContainer');
            container.innerHTML = '';
            
            services.forEach(service => {
                const serviceElement = document.createElement('div');
                serviceElement.className = 'service-item';
                serviceElement.dataset.id = service.id;
                serviceElement.innerHTML = `
                    <div class="service-name">${service.name}</div>
                    <div class="service-price">${service.price} درهم</div>
                `;
                
                serviceElement.addEventListener('click', () => toggleService(service.id, serviceElement));
                container.appendChild(serviceElement);
            });
        }

        function toggleService(serviceId, serviceElement) {
            const service = services.find(s => s.id === serviceId);
            const index = selectedServices.findIndex(s => s.id === serviceId);
            
            if (index > -1) {
                selectedServices.splice(index, 1);
                serviceElement.classList.remove('selected');
            } else {
                selectedServices.push(service);
                serviceElement.classList.add('selected');
            }
            updateTotalAmount();
        }

        function updateTotalAmount() {
            totalAmount = selectedServices.reduce((sum, service) => sum + service.price, 0);
            document.getElementById('servicesTotal').textContent = totalAmount + ' درهم';
            document.getElementById('requestedPriceDisplay').textContent = totalAmount + ' درهم';
            
            paidAmount = paymentHistory.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
            const remaining = totalAmount - paidAmount;
            document.getElementById('remainingAmount').textContent = remaining + ' درهم';
            
            // تحديث ألوان المبلغ المتبقي
            const remainingElement = document.getElementById('remainingAmount');
            if (remaining < 0) {
                remainingElement.style.color = '#e63946';
            } else if (remaining === 0) {
                remainingElement.style.color = '#2ecc71';
            } else {
                remainingElement.style.color = 'white';
            }
            
            document.getElementById('firstPaymentAmount').textContent = (totalAmount / 2) + ' درهم';
            document.getElementById('secondPaymentAmount').textContent = (totalAmount / 2) + ' درهم';
        }

        function setupEventListeners() {
            // البحث
            document.getElementById('searchButton').addEventListener('click', searchClients);
            
            // طلب فاتورة
            document.getElementById('showInvoiceButton').addEventListener('click', showInvoice);
            
            // الدفعات
            document.getElementById('confirmFirstPayment').addEventListener('click', () => confirmPayment('first'));
            document.getElementById('confirmSecondPayment').addEventListener('click', () => confirmPayment('second'));
            
            // الدفعات من قسم الفاتورة
            document.getElementById('invoiceConfirmFirstPayment').addEventListener('click', () => confirmPayment('first'));
            document.getElementById('invoiceConfirmSecondPayment').addEventListener('click', () => confirmPayment('second'));
            
            // إغلاق قسم الفاتورة
            document.getElementById('closeInvoiceSection').addEventListener('click', function() {
                document.getElementById('invoiceSection').style.display = 'none';
            });
            
            // طباعة الفاتورة
            document.getElementById('printInvoice').addEventListener('click', printInvoice);
            
            // التنقل مع كلمة السر
            document.getElementById('goToClientsPage').addEventListener('click', () => {
                const password = prompt('أدخل كلمة السر للدخول إلى صفحة العملاء:');
                if (password === '2004') window.location.href = 'clients.html';
                else if (password) alert('كلمة السر غير صحيحة!');
            });

            document.getElementById('goToInvoicesPage').addEventListener('click', () => {
                const password = prompt('أدخل كلمة السر للدخول إلى صفحة الفواتير:');
                if (password === '2004') window.location.href = 'invoices.html';
                else if (password) alert('كلمة السر غير صحيحة!');
            });

            document.getElementById('goToInventoryPage').addEventListener('click', () => {
                const password = prompt('أدخل كلمة السر للدخول إلى صفحة الجرد:');
                if (password === '2004') window.location.href = 'inventory.html';
                else if (password) alert('كلمة السر غير صحيحة!');
            });

            document.getElementById('goToDashboardPage').addEventListener('click', () => {
                const password = prompt('أدخل كلمة السر للدخول إلى لوحة التحكم:');
                if (password === '2004') window.location.href = 'dashboard.html';
                else if (password) alert('كلمة السر غير صحيحة!');
            });
            
            // تأكيد الطلب - الإصدار المصحح
            document.getElementById('submitOrder').addEventListener('click', submitOrderWithFirebase);

            // إدارة الخدمات
            document.getElementById('addService').addEventListener('click', addNewServiceWithFirebase);

            // دخول الإدارة
            document.getElementById('adminLogin').addEventListener('click', adminLogin);

            // تبديل عرض كلمة السر
            document.getElementById('toggleClientPassword').addEventListener('click', function() {
                togglePasswordVisibility('clientEmailPassword', 'toggleClientPassword');
            });

            // زر تصفير سجل المدفوعات
            document.getElementById('resetPaymentsBtn').addEventListener('click', function() {
                const password = prompt('أدخل كلمة السر لتصفير سجل المدفوعات:');
                if (password === '2004') {
                    paymentHistory = [];
                    updatePaymentHistory();
                    updateTotalAmount();
                    resetPaymentBoxes(); // إضافة جديدة: إعادة تعيين مربعات الدفعات
                    triggerAutoSave();
                    alert('تم تصفير سجل المدفوعات بنجاح');
                } else if (password) {
                    alert('كلمة السر غير صحيحة');
                }
            });

            // إضافة جديدة: تحديث رقم الفاتورة
            document.getElementById('updateInvoiceCounter').addEventListener('click', updateInvoiceCounter);
        }

        // إضافة جديدة: إعادة تعيين مربعات الدفعات
        function resetPaymentBoxes() {
            const firstPayment = document.getElementById('firstPayment');
            const secondPayment = document.getElementById('secondPayment');
            
            firstPayment.className = 'price-box pending';
            firstPayment.querySelector('.payment-status').textContent = 'قيد الانتظار';
            firstPayment.querySelector('.payment-status').className = 'payment-status pending';
            
            secondPayment.className = 'price-box pending';
            secondPayment.querySelector('.payment-status').textContent = 'قيد الانتظار';
            secondPayment.querySelector('.payment-status').className = 'payment-status pending';
        }

        // إضافة جديدة: تحديث رقم الفاتورة
        async function updateInvoiceCounter() {
            const newCounter = parseInt(document.getElementById('newInvoiceCounter').value);
            
            if (!newCounter || newCounter < 0) {
                alert('يرجى إدخال رقم صحيح');
                return;
            }
            
            clientCounter = newCounter;
            await saveClientCounter();
            generateClientId();
            updateInvoiceCounterDisplay();
            alert('تم تحديث رقم الفاتورة بنجاح');
        }

        // إضافة جديدة: تحديث عرض رقم الفاتورة
        function updateInvoiceCounterDisplay() {
            document.getElementById('currentInvoiceCounter').textContent = clientCounter;
        }

        // دالة حفظ العميل مع Firebase - الإصدار المصحح
        async function submitOrderWithFirebase() {
            console.log("بدء عملية تسجيل الطلب مع المزامنة الفورية...");
            
            const clientName = document.getElementById('clientName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const clientEmail = document.getElementById('clientEmail').value.trim();
            const clientEmailPassword = document.getElementById('clientEmailPassword').value.trim();
            
            console.log("البيانات المدخلة:", { clientName, phone, clientEmail, clientEmailPassword });
            
            // التحقق من الحقول المطلوبة
            if (!clientName) {
                alert('يرجى إدخال اسم العميل');
                document.getElementById('clientName').focus();
                return;
            }
            
            if (!phone) {
                alert('يرجى إدخال رقم التليفون');
                document.getElementById('phone').focus();
                return;
            }
            
            if (!clientEmail) {
                alert('يرجى إدخال البريد الإلكتروني');
                document.getElementById('clientEmail').focus();
                return;
            }
            
            if (!clientEmailPassword) {
                alert('يرجى إدخال كلمة سر الإيميل');
                document.getElementById('clientEmailPassword').focus();
                return;
            }
            
            // التحقق من الخدمات المختارة
            if (selectedServices.length === 0) {
                alert('يرجى اختيار خدمة واحدة على الأقل');
                return;
            }
            
            // إظهار مؤشر التحميل
            const submitBtn = document.getElementById('submitOrder');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
            submitBtn.disabled = true;
            
            try {
                // تجهيز بيانات العميل
                const clientData = {
                    id: document.getElementById('clientId').value,
                    name: clientName,
                    phone: phone,
                    email: clientEmail,
                    emailPassword: clientEmailPassword,
                    registrationDate: document.getElementById('registrationDate').value,
                    company: document.getElementById('companyName').value || '',
                    serviceCategory: document.getElementById('serviceCategory').value || '',
                    details: document.getElementById('details').value || '',
                    selectedServices: selectedServices,
                    totalAmount: totalAmount,
                    paymentHistory: paymentHistory,
                    timestamp: new Date().getTime(),
                    lastUpdated: new Date().getTime()
                };
                
                console.log("بيانات العميل المجهزة:", clientData);
                
                // محاولة الحفظ في Firebase
                const result = await firebaseApp.addClient(clientData);
                console.log("نتيجة الحفظ في Firebase:", result);
                
                if (result.success) {
                    // تم الحفظ في Firebase بنجاح - البيانات ستُبث تلقائياً لجميع الأجهزة
                    showAutoSaveIndicator('تم حفظ العميل والمزامنة الفورية', 'saved');
                    
                    // إضافة المعاملات المالية تلقائياً إذا كانت هناك مدفوعات
                    if (paymentHistory.length > 0) {
                        await addPaymentsToInventory(clientData);
                    }
                    
                    alert('✅ تم حفظ العميل بنجاح! سيظهر التغيير في جميع الأجهزة فوراً.');
                    resetForm();
                    
                } else {
                    throw new Error('فشل الحفظ في Firebase');
                }
                
            } catch (error) {
                console.error('❌ خطأ في الحفظ:', error);
                // محاولة الحفظ محلياً والانتظار للمزامنة لاحقاً
                try {
                    const clientData = {
                        id: document.getElementById('clientId').value,
                        name: clientName,
                        phone: phone,
                        email: clientEmail,
                        emailPassword: clientEmailPassword,
                        registrationDate: document.getElementById('registrationDate').value,
                        company: document.getElementById('companyName').value || '',
                        serviceCategory: document.getElementById('serviceCategory').value || '',
                        details: document.getElementById('details').value || '',
                        selectedServices: selectedServices,
                        totalAmount: totalAmount,
                        paymentHistory: paymentHistory,
                        timestamp: new Date().getTime(),
                        syncStatus: 'pending'
                    };
                    
                    if (currentClientId) {
                        const index = savedClients.findIndex(client => client.id === currentClientId);
                        if (index !== -1) {
                            savedClients[index] = clientData;
                        }
                    } else {
                        savedClients.push(clientData);
                        clientCounter++;
                        await saveClientCounter();
                    }
                    
                    localStorage.setItem('savedClients', JSON.stringify(savedClients));
                    
                    alert('✅ تم الحفظ محلياً بنجاح! سيتم المزامنة عند استعادة الاتصال.');
                    resetForm();
                    
                } catch (localError) {
                    console.error('❌ خطأ في الحفظ المحلي:', localError);
                    alert('❌ حدث خطأ في حفظ البيانات. يرجى المحاولة مرة أخرى.');
                }
            } finally {
                // إعادة تعيين زر الحفظ
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // دالة إضافة المدفوعات إلى الجرد
        async function addPaymentsToInventory(clientData) {
            try {
                for (const payment of paymentHistory) {
                    const transaction = {
                        id: 'CLIENT-' + clientData.id + '-' + Date.now(),
                        type: 'دخل',
                        category: 'مدفوعات عملاء',
                        amount: payment.amount,
                        description: `دفعة ${payment.type} من العميل ${clientData.name}`,
                        date: payment.date,
                        timestamp: new Date().getTime(),
                        source: 'clients',
                        clientId: clientData.id,
                        paymentType: payment.type
                    };
                    
                    await firebaseApp.addTransaction(transaction);
                }
                console.log("✅ تم إضافة المدفوعات إلى الجرد");
            } catch (error) {
                console.error("❌ خطأ في إضافة المدفوعات إلى الجرد:", error);
            }
        }

        // إضافة خدمة جديدة مع Firebase
        async function addNewServiceWithFirebase() {
            const name = document.getElementById('newServiceName').value;
            const price = parseFloat(document.getElementById('newServicePrice').value);
            
            if (!name || !price) {
                alert('يرجى ملء جميع الحقول');
                return;
            }
            
            const newService = {
                id: services.length > 0 ? Math.max(...services.map(s => s.id)) + 1 : 1,
                name: name,
                price: price,
                timestamp: new Date().getTime()
            };
            
            // إضافة الخدمة محلياً
            services.push(newService);
            saveServicesToStorage();
            renderServices();
            updateAdminTable();
            
            // محاولة الإضافة إلى Firebase
            const result = await firebaseApp.addService(newService);
            
            if (result.success) {
                showAutoSaveIndicator('تم إضافة الخدمة والمزامنة', 'saved');
            } else {
                showAutoSaveIndicator('تم الإضافة محلياً (بانتظار الاتصال)', 'saving');
            }
            
            document.getElementById('newServiceName').value = '';
            document.getElementById('newServicePrice').value = '';
            
            alert('تم إضافة الخدمة بنجاح');
        }

        function togglePasswordVisibility(passwordFieldId, toggleButtonId) {
            const passwordField = document.getElementById(passwordFieldId);
            const toggleButton = document.getElementById(toggleButtonId);
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                passwordField.type = 'password';
                toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === '2004') {
                document.getElementById('adminSection').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                alert('تم الدخول إلى لوحة الإدارة بنجاح');
            } else {
                alert('كلمة المرور غير صحيحة');
            }
        }

        function updateAdminTable() {
            const servicesTable = document.getElementById('servicesTable');
            servicesTable.innerHTML = '';
            
            services.forEach(service => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${service.name}</td>
                    <td>${service.price} درهم</td>
                    <td>
                        <button class="admin-btn btn-edit" data-id="${service.id}">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="admin-btn btn-delete" data-id="${service.id}">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                `;
                
                row.querySelector('.btn-edit').addEventListener('click', function() {
                    editService(service.id);
                });
                
                row.querySelector('.btn-delete').addEventListener('click', function() {
                    deleteService(service.id);
                });
                
                servicesTable.appendChild(row);
            });
        }

        async function editService(serviceId) {
            const service = services.find(s => s.id === serviceId);
            if (service) {
                const newName = prompt('أدخل الاسم الجديد للخدمة:', service.name);
                const newPrice = prompt('أدخل السعر الجديد للخدمة:', service.price);
                
                if (newName && newPrice) {
                    service.name = newName;
                    service.price = parseFloat(newPrice);
                    
                    // تحديث محلي
                    saveServicesToStorage();
                    renderServices();
                    updateAdminTable();
                    
                    // محاولة التحديث في Firebase
                    const result = await firebaseApp.updateService(serviceId, {
                        name: newName,
                        price: parseFloat(newPrice)
                    });
                    
                    if (result.success) {
                        showAutoSaveIndicator('تم تحديث الخدمة والمزامنة', 'saved');
                    } else {
                        showAutoSaveIndicator('تم التحديث محلياً (بانتظار الاتصال)', 'saving');
                    }
                    
                    alert('تم تعديل الخدمة بنجاح');
                }
            }
        }

        async function deleteService(serviceId) {
            if (confirm('هل أنت متأكد من حذف هذه الخدمة؟')) {
                services = services.filter(s => s.id !== serviceId);
                
                // حذف محلي
                saveServicesToStorage();
                renderServices();
                updateAdminTable();
                
                // محاولة الحذف من Firebase
                const result = await firebaseApp.deleteService(serviceId);
                
                if (result.success) {
                    showAutoSaveIndicator('تم حذف الخدمة والمزامنة', 'saved');
                } else {
                    showAutoSaveIndicator('تم الحذف محلياً (بانتظار الاتصال)', 'saving');
                }
                
                alert('تم حذف الخدمة بنجاح');
            }
        }

        function searchClients() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const results = savedClients.filter(client => 
                client.name.toLowerCase().includes(term) ||
                client.phone.includes(term) ||
                client.id.toLowerCase().includes(term)
            );
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">لا توجد نتائج</div>';
                return;
            }
            
            container.innerHTML = results.map(client => `
                <div class="search-result-item" data-client-id="${client.id}">
                    <div class="client-info">
                        <div>
                            <div class="client-name">${client.name}</div>
                            <div>${client.phone} | ${client.email}</div>
                        </div>
                        <div class="client-id-badge">${client.id}</div>
                    </div>
                </div>
            `).join('');
            
            // إضافة حدث النقر لنتائج البحث
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const clientId = this.dataset.clientId;
                    loadClientData(clientId);
                });
            });
        }

        function loadClientData(clientId) {
            const client = savedClients.find(c => c.id === clientId);
            if (client) {
                // تعبئة بيانات العميل في النموذج
                document.getElementById('clientName').value = client.name;
                document.getElementById('phone').value = client.phone;
                document.getElementById('clientEmail').value = client.email;
                document.getElementById('clientEmailPassword').value = client.emailPassword || '';
                document.getElementById('clientId').value = client.id;
                document.getElementById('registrationDate').value = client.registrationDate;
                document.getElementById('companyName').value = client.company || '';
                document.getElementById('serviceCategory').value = client.serviceCategory || '';
                document.getElementById('details').value = client.details || '';
                
                // تعبئة الخدمات المختارة
                selectedServices = client.selectedServices || [];
                renderServices();
                
                // تعبئة سجل المدفوعات
                paymentHistory = client.paymentHistory || [];
                updatePaymentHistory();
                
                // تحديث المبالغ
                totalAmount = client.totalAmount || 0;
                updateTotalAmount();
                
                // تحديث حالة الدفعات
                updatePaymentBoxes();
                
                // حفظ معرف العميل الحالي
                currentClientId = clientId;
                
                // عرض رسالة نجاح
                alert('تم تحميل بيانات العميل بنجاح');
            }
        }

        // إضافة جديدة: تحديث حالة مربعات الدفعات
        function updatePaymentBoxes() {
            const firstPaymentPaid = paymentHistory.some(p => p.type === 'الدفعة الأولى');
            const secondPaymentPaid = paymentHistory.some(p => p.type === 'الدفعة الثانية');
            
            const firstPayment = document.getElementById('firstPayment');
            const secondPayment = document.getElementById('secondPayment');
            
            if (firstPaymentPaid) {
                firstPayment.className = 'price-box paid';
                firstPayment.querySelector('.payment-status').textContent = 'تم الدفع';
                firstPayment.querySelector('.payment-status').className = 'payment-status paid';
            } else {
                firstPayment.className = 'price-box pending';
                firstPayment.querySelector('.payment-status').textContent = 'قيد الانتظار';
                firstPayment.querySelector('.payment-status').className = 'payment-status pending';
            }
            
            if (secondPaymentPaid) {
                secondPayment.className = 'price-box paid';
                secondPayment.querySelector('.payment-status').textContent = 'تم الدفع';
                secondPayment.querySelector('.payment-status').className = 'payment-status paid';
            } else {
                secondPayment.className = 'price-box pending';
                secondPayment.querySelector('.payment-status').textContent = 'قيد الانتظار';
                secondPayment.querySelector('.payment-status').className = 'payment-status pending';
            }
        }

        function showInvoice() {
            // التحقق من وجود بيانات العميل
            const clientName = document.getElementById('clientName').value;
            if (!clientName) {
                alert('يرجى إدخال بيانات العميل أولاً');
                return;
            }
            
            // عرض قسم الفاتورة
            document.getElementById('invoiceSection').style.display = 'block';
            
            // تحديث بيانات الفاتورة
            updateInvoice();
        }

        function updateInvoice() {
            const clientName = document.getElementById('clientName').value;
            const clientId = document.getElementById('clientId').value;
            const phone = document.getElementById('phone').value;
            const clientEmail = document.getElementById('clientEmail').value;
            const registrationDate = document.getElementById('registrationDate').value;
            
            // تحديث معلومات العميل في الفاتورة
            document.getElementById('invoiceClientName').textContent = clientName;
            document.getElementById('invoiceClientId').textContent = `رقم العميل: ${clientId}`;
            document.getElementById('invoiceClientPhone').textContent = `رقم الهاتف: ${phone}`;
            document.getElementById('invoiceClientEmail').textContent = `البريد الإلكتروني: ${clientEmail}`;
            
            // تحديث معلومات الفاتورة
            document.getElementById('invoiceDate').textContent = `تاريخ الفاتورة: ${registrationDate}`;
            document.getElementById('invoiceNumber').textContent = `رقم الفاتورة: INV-${clientId}`;
            
            // تحديث حالة الفاتورة
            const statusText = paidAmount === totalAmount ? 'مكتملة' : 
                              paidAmount > 0 ? 'قيد الانتظار' : 'غير مدفوعة';
            document.getElementById('invoiceStatus').textContent = `حالة الفاتورة: ${statusText}`;
            
            // تحديث الخدمات في الفاتورة
            const servicesList = document.getElementById('invoiceServicesList');
            servicesList.innerHTML = '';
            
            if (selectedServices.length === 0) {
                servicesList.innerHTML = '<p>لا توجد خدمات مختارة</p>';
            } else {
                selectedServices.forEach(service => {
                    const serviceItem = document.createElement('div');
                    serviceItem.className = 'invoice-service-item';
                    serviceItem.innerHTML = `
                        <span>${service.name}</span>
                        <span>${service.price} درهم</span>
                    `;
                    servicesList.appendChild(serviceItem);
                });
            }
            
            // تحديث المبالغ في الفاتورة
            document.getElementById('invoiceTotalAmount').textContent = totalAmount + ' درهم';
            document.getElementById('invoicePaidAmount').textContent = paidAmount + ' درهم';
            document.getElementById('invoiceRemainingAmount').textContent = (totalAmount - paidAmount) + ' درهم';
            
            // تحديث حالة الدفعات في الفاتورة
            const firstPaymentPaid = paymentHistory.some(p => p.type === 'الدفعة الأولى');
            const secondPaymentPaid = paymentHistory.some(p => p.type === 'الدفعة الثانية');
            
            document.getElementById('invoiceFirstPaymentAmount').textContent = (totalAmount / 2) + ' درهم';
            document.getElementById('invoiceSecondPaymentAmount').textContent = (totalAmount / 2) + ' درهم';
            
            const firstPaymentStatus = document.getElementById('invoiceFirstPaymentStatus');
            const secondPaymentStatus = document.getElementById('invoiceSecondPaymentStatus');
            
            if (firstPaymentPaid) {
                firstPaymentStatus.textContent = 'تم الدفع';
                firstPaymentStatus.className = 'payment-status-badge badge-paid';
                document.getElementById('invoiceFirstPayment').classList.add('paid');
            } else {
                firstPaymentStatus.textContent = 'قيد الانتظار';
                firstPaymentStatus.className = 'payment-status-badge badge-pending';
                document.getElementById('invoiceFirstPayment').classList.remove('paid');
            }
            
            if (secondPaymentPaid) {
                secondPaymentStatus.textContent = 'تم الدفع';
                secondPaymentStatus.className = 'payment-status-badge badge-paid';
                document.getElementById('invoiceSecondPayment').classList.add('paid');
            } else {
                secondPaymentStatus.textContent = 'قيد الانتظار';
                secondPaymentStatus.className = 'payment-status-badge badge-pending';
                document.getElementById('invoiceSecondPayment').classList.remove('paid');
            }
        }

        function printInvoice() {
            // إنشاء نافذة طباعة
            const printWindow = window.open('', '_blank');
            const invoiceContent = document.getElementById('invoiceSection').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>فاتورة العميل</title>
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            padding: 20px;
                        }
                        .invoice-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #4361ee;
                            padding-bottom: 15px;
                        }
                        .invoice-details {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 20px;
                        }
                        .invoice-services {
                            margin-bottom: 20px;
                        }
                        .invoice-service-item {
                            display: flex;
                            justify-content: space-between;
                            padding: 10px 0;
                            border-bottom: 1px solid #e0e0e0;
                        }
                        .invoice-totals {
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 10px;
                            margin-bottom: 20px;
                        }
                        .invoice-total-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                        }
                        .invoice-total-row:last-child {
                            margin-bottom: 0;
                            font-weight: bold;
                            border-top: 1px solid #ddd;
                            padding-top: 10px;
                        }
                        .invoice-payment-status {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                            margin-bottom: 20px;
                        }
                        .payment-status-box {
                            border: 1px solid #ddd;
                            padding: 15px;
                            border-radius: 10px;
                            text-align: center;
                        }
                        .payment-status-box.paid {
                            border-color: #4cc9f0;
                            background: rgba(76, 201, 240, 0.1);
                        }
                        .payment-status-amount {
                            font-size: 1.5rem;
                            font-weight: bold;
                            margin: 10px 0;
                        }
                        .payment-status-badge {
                            display: inline-block;
                            padding: 5px 10px;
                            border-radius: 15px;
                            font-size: 0.8rem;
                            font-weight: bold;
                        }
                        .badge-paid {
                            background: #4cc9f0;
                            color: white;
                        }
                        .badge-pending {
                            background: #fca311;
                            color: white;
                        }
                        @media print {
                            body {
                                padding: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        async function confirmPayment(type) {
            if (totalAmount === 0) {
                alert('اختر الخدمات أولاً');
                return;
            }
            
            const amount = totalAmount / 2;
            const paymentType = type === 'first' ? 'الدفعة الأولى' : 'الدفعة الثانية';
            
            // التحقق من عدم تسجيل الدفعة مسبقاً
            if (paymentHistory.some(p => p.type === paymentType)) {
                alert('تم تسجيل هذه الدفعة مسبقاً');
                return;
            }
            
            const payment = {
                type: paymentType,
                amount: amount,
                date: new Date().toLocaleDateString('ar-EG'),
                timestamp: new Date().getTime()
            };
            
            paymentHistory.push(payment);
            updatePaymentHistory();
            updateTotalAmount();
            updateInvoice();
            
            // تحديث حالة مربعات الدفعات
            updatePaymentBoxes();
            
            // إضافة معاملة مالية إلى الجرد
            const transactionData = {
                type: 'دخل',
                category: 'مدفوعات عملاء',
                amount: amount,
                description: `دفعة ${paymentType} من العميل ${document.getElementById('clientName').value}`,
                date: new Date().toLocaleDateString('ar-EG'),
                timestamp: new Date().getTime(),
                source: 'clients',
                clientId: document.getElementById('clientId').value,
                paymentType: paymentType
            };
            
            await firebaseApp.addTransaction(transactionData);
            
            triggerAutoSave();
            
            alert(`تم تأكيد ${paymentType} بنجاح`);
        }

        function updatePaymentHistory() {
            const container = document.getElementById('paymentHistory');
            if (paymentHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">لا توجد مدفوعات مسجلة بعد</p>';
                return;
            }
            
            container.innerHTML = paymentHistory.map(payment => `
                <div class="payment-history-item">
                    <span>${payment.type} - ${payment.date}</span>
                    <span><strong>${payment.amount} درهم</strong></span>
                </div>
            `).join('');
        }

        function resetForm() {
            console.log("بدء إعادة تعيين النموذج...");
            
            // إعادة تعيين الحقول
            document.getElementById('clientName').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientEmailPassword').value = '';
            document.getElementById('companyName').value = '';
            document.getElementById('serviceCategory').selectedIndex = 0;
            document.getElementById('details').value = '';
            
            // إعادة تعيين المتغيرات
            selectedServices = [];
            paymentHistory = [];
            currentClientId = null;
            totalAmount = 0;
            paidAmount = 0;
            
            // توليد معرف جديد وتاريخ جديد
            generateClientId();
            setRegistrationDate();
            
            // تحديث الواجهة
            updateTotalAmount();
            updatePaymentHistory();
            
            // إعادة تعيين الخدمات المختارة
            document.querySelectorAll('.service-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            
            // إعادة تعيين حالة الدفعات
            resetPaymentBoxes();
            
            // إخفاء قسم الفاتورة
            document.getElementById('invoiceSection').style.display = 'none';
            
            console.log("✅ تم إعادة تعيين النموذج بنجاح");
        }

        function loadSavedClients() {
            const stored = localStorage.getItem('savedClients');
            if (stored) savedClients = JSON.parse(stored);
        }

        // دوال معالجة تحديثات Firebase
        window.updateClientsFromFirebase = function(clientsData) {
            if (clientsData) {
                const clientsArray = Object.values(clientsData);
                savedClients = clientsArray;
                localStorage.setItem('savedClients', JSON.stringify(clientsArray));
                
                // تحديث العداد إذا لزم الأمر
                if (clientsArray.length > 0) {
                    const maxId = Math.max(...clientsArray.map(client => {
                        const idNum = client.id.replace('CL', '');
                        return parseInt(idNum) || 0;
                    }));
                    if (maxId >= clientCounter) {
                        clientCounter = maxId + 1;
                        saveClientCounter();
                        generateClientId();
                    }
                }
                
                console.log("✅ تم تحديث العملاء من Firebase");
            }
        };

        window.updateServicesFromFirebase = function(servicesData) {
            if (servicesData) {
                services = Object.values(servicesData);
                saveServicesToStorage();
                renderServices();
                updateAdminTable();
                console.log("✅ تم تحديث الخدمات من Firebase");
            }
        };

        window.updateSettingsFromFirebase = function(settingsData) {
            if (settingsData) {
                if (settingsData.clientCounter) {
                    clientCounter = settingsData.clientCounter;
                    generateClientId();
                }
                console.log("✅ تم تحديث الإعدادات من Firebase");
            }
        };
    </script>
</body>
</html>